---
title: "Frequently Asked Questions and Limitations"
author: "Jonathan Bakdash and Laura Marusich"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Frequently Asked Questions and Limitations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = FALSE)
options(width = 80)
library("knitr", "rmarkdown", "rmcorr") #, "stats")
require(knitr)
require(rmarkdown)
require(rmcorr)
```
## Frequently Asked Questions 

### How to Calculate Power
Power can be calculated using the \emph{power.rmcorr} function. This function 
modifies pwr.r.test from the <a href="https://CRAN.R-project.org/package=pwr">pwr</a> 
package to use the rmcorr degrees of freedom. It is not presently included in 
the rmcorr package. 

Notation: *N* is the sample size and *k* the (average) number of repeated 
measures for each individual.

#### power.rmcorr Example
*N* = 100, *k* = 3, and *r*<sub>*rm*</sub> = 0.20. This design has 82\% power.

`r ''````{r}
install.packages("pwr")
require(pwr)

power.rmcorr <- function(k, N, effectsizer, sig)
    {pwr.r.test(n = ((N)*(k-1))+1, r = effectsizer, sig.level = sig)}
    
power.rmcorr(3, 100, 0.20, 0.05)    
#> 
#>      approximate correlation power calculation (arctangh transformation) 
#> 
#>               n = 201
#>               r = 0.2
#>       sig.level = 0.05
#>           power = 0.8156984
#>     alternative = two.sided
```

See [Power curves](./New_rmcorr_paper_analyses_figures.html#power) for more information. 

For <a href="https://www.psychologie.hhu.de/arbeitsgruppen/allgemeine-psychologie-und-arbeitspsychologie/gpower">G\*Power</a> or other software, power can be calculated by substituting the rmcorr degrees of freedom for a Pearson correlation. Instead of sample size, use the degrees of freedom for rmcorr plus two (effective sample size). This is because a Pearson correlation has *N* - 2 degrees of freedom.<br>


- Rmcorr exact degrees of freedom = *N* x (*k* - 1) - 1 <br>
- Approximate degrees of freedom = (*N* -1) x (*k* - 1)  <br>

#### Exact Degrees of Freedom Example
Values: *N* = 100, *k* = 3 , and *r*<sub>*rm*</sub> = 0.20 (same as above) <br> 
rmcorr df = 100 x (3 - 1) - 1 = 200 - 1 = 199 <br>
Add two (kludge): 199 + 2 = 201 <br>
Enter *N* = 201 as the effective sample size in G\*Power <br>
G\*Power will calculate the degrees of freedom as *N* - 2 = 201 - 2 = 199. 
Thus, using the correct degrees of freedom for rmcorr.
<br>

*Note* power is just slighty different in than the same calulcation in R, which uses an approximation.

![G\*Power using the exact degrees of freedom](man/figures/Gpower_exact_df.jpg)

#### Approximate Degrees of Freedom Example
Vaules: *N* = 100, *k* = 3, and *r*<sub>*rm*</sub> = 0.20 (again, same as above) <br>
approx rmcorr df = (100 - 1) x (3 - 1) = 99 x 2 = 198 <br>
Note the small difference between the approximate vs. exact calculation: *one* degree of freedom <br>
Add two (same kludge) for G\*Power, entering a sample size of *N* = 200 <br>

*Note* power is slighty different than the exact formula above. 
![G\*Power using the approx degrees of freedom](man/figures/Gpower_exact_df.jpg)

### How to Extract the Slope and its Confidence Interval
```{r}
my.rmc <- rmcorr(participant = Subject, measure1 = PaCO2, measure2 = pH, 
                 dataset = bland1995)
 
# Structure of rmcorr object
#str(my.rmc)
 
# Extract rmcorr model coefficients
coef.rmc  <- my.rmc$model$coefficients
coef.rmc
 
slope.rmc <- coef.rmc[length(coef.rmc)] #Last value in coefficients is the slope
slope.rmc
 
# Confidence intervals around all estimates
coef.CIs <- stats::confint(my.rmc$model) 
coefs.all <- cbind(coef.rmc, coef.CIs)
coefs.all
```

### isa Error
**tldr**: Updating R appears to resolve this error. <br>

We have had reports of this error when running rmcorr: <br>
`r ''````{r}
Error in isa(Participant, "character") : could not find function "isa" 
```

<a href="https://stackoverflow.com/questions/73146762/how-to-solve-the-following-error-running-rmcorr-in-r-error-in-isaparticipant">Stack Question with error</a>

#### Cause(s) for the error? 
rmcorr uses isa(). isa() is a base function included with R. We think this error 
occurs in versions of R prior to 3.5.0 (due to a change in serialization?) and 
also ran into the error in R 4.0.4 

Code to test if isa() works:
`r ''````{r}
isa("test", "character")
isa(5, "numeric")
```

If there is a different error with isa, another possibility is that an older 
package may have overwritten the base isa() function:
`r ''````{r}
base::isa("test", "character")
base::isa(5, "numeric")
```

### Transformations
Transformations can be used to make the data (errors) more normal. We highly recommend graphing both the raw and transformed data.
<br>
It may be appropriate to only transform one measure or transform both measures. "Consider transforming every variable in sight" (Gelman \& Hill, 2017: *Data Analysis Using Regression and Multilevel/Hierarchical Models*, ISBN: 9780521686891, p. 548): <a href="https://www.google.com/books/edition/Data_Analysis_Using_Regression_and_Multi/lV3DIdV0F9AC?hl=en&gbpv=1&bsq=consider%20transforming%20every%20variable%20in%20sight">Google Books</a> 
<br>

## Limitations 

### Change Over Time 
In general, rmcorr is a time-independent model-- it does not model change over time. A partial
exception is if time is a measure, such as age in the raz2005 dataset.
<br>

### Varying Slopes with Influential Observations and/or Unbalanced Data 
If slopes meaningfully vary by individual, we recommend using multilevel modeling instead of rmcorr.
Random effect slopes are even more \emph{problematic} for rmcorr with influential observations
and/or highly unbalanced data. This is nicely illustrated in simulations by Dr. Marta Karas: 
<br>
<a href="https://martakarass.github.io/post/2022-04-27-rmcorr_vs_lmm/">When rmcorr may not be ideal</a> 

