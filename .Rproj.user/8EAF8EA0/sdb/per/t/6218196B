{
    "collab_server" : "",
    "contents" : "---\ntitle: '\"Extra markdown no longer in paper\"'\nauthor: \"Jon Bakdash and Laura Marusich\"\ndate: \"June 30, 2016\"\noutput: html_document\n---\n\n## R Markdown\n\nThis is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.\n\n```{r, echo=FALSE, warning=FALSE, message=FALSE}\nrequire(pwr)\nrequire(psych) \nrequire(Hmisc)\nrequire(RColorBrewer)\nrequire(grDevices)\nrequire(plotrix)\nrequire(metafor)\nlibrary(rmcorr)\nrequire(devtools) #Comment out in final version\nrequire(lme4)\nrequire(AICcmodavg)\nrequire(MuMIn)\n#install_github('lmarusich/rmcorr')\n\n#require(checkpoint)\n#checkpoint(\"2016-XX-YY\") #Won't work yet b/c rmcorr doesn't yet exist in CRAN\n#require(memoise)\naddalpha <- function(colors, alpha=1.0) {\n  r <- col2rgb(colors, alpha=T)\n  # Apply alpha\n  r[4,] <- alpha*255\n  r <- r/255.0\n  return(rgb(r[1,], r[2,], r[3,], r[4,]))\n}\n\n# colorRampPaletteAlpha()\ncolorRampPaletteAlpha <- function(colors, n=32, interpolate='linear') {\n  # Create the color ramp normally\n  cr <- colorRampPalette(colors, interpolate=interpolate)(n)\n  # Find the alpha channel\n  a <- col2rgb(colors, alpha=T)[4,]\n  # Interpolate\n  if (interpolate=='linear') {\n    l <- approx(a, n=n)\n  } else {\n    l <- spline(a, n=n)\n  }\n  l$y[l$y > 255] <- 255 # Clamp if spline is > 255\n  cr <- addalpha(cr, l$y/255.0)\n  return(cr)\n}\n\n```\n\n###7. Complete pooling examples (fit a single model to all data points) using regression: Size and Distance\n##### a) Regression Results \n```{r, echo = FALSE}\nSizeDistPoolAll.lm<-lm(Emmert_distance_meters~Perceived_dist, data = Size_distance)\nprint(SizeDistPoolAll.lm)\nsummary(SizeDistPoolAll.lm)\ncor.test(Size_distance$Emmert_distance_meters, Size_distance$Perceived_dist)\n\n#Complete Pooling by block: Single model fit to data averaged by block, by participant \nBlockSizeDistance<-aggregate(cbind(Emmert_distance_meters, Perceived_dist) ~ Actual_dist_meters + Participant, FUN = mean, data=Size_distance)\nSizeDistBlock.lm<-lm(Emmert_distance_meters~Perceived_dist , data = BlockSizeDistance)\nprint(SizeDistBlock.lm)\nsummary(SizeDistBlock.lm)\ncor.test(BlockSizeDistance$Emmert_distance_meters, BlockSizeDistance$Perceived_dist)\n\n```\n\n##### b) Figure 7\n```{r, echo = FALSE}\npar(mfrow=c(1,2), mar=c(5,4.6,4,0.5), mgp=c(3.2,0.8,0),  oma = c(0, 0, 0, 0), las = 1)\n\nplot(Emmert_distance_meters~Perceived_dist, data = Size_distance, pch = 16, \n     col=rgb(red = 0.0, green = 0.0, blue = 0.0, alpha = 0.3),\n     main = \"a) Complete Pooling: All Data\",\n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance (m)\", \n     las = 1) \nabline(SizeDistPoolAll.lm, col = \"red\", lwd = 2)\naxis.break(axis = 1, style = \"slash\")\naxis.break(axis = 2, style = \"slash\")\n\nSizeDistBlock.lm\nplot(Emmert_distance_meters~Perceived_dist, data = BlockSizeDistance, pch = 16, \n     col=rgb(red = 0.0, green = 0.0, blue = 0.0, alpha = 0.3),\n     main = \"b) Complete Pooling: \\nAveraged by Block, by Participant\",\n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance (m)\", \n     las = 1) \nabline(SizeDistBlock.lm, col = \"red\", lwd = 2)\naxis.break(axis = 1, style = \"slash\")\naxis.break(axis = 2, style = \"slash\")\n\ndev.copy(pdf, file=\"plots/Figure7_CompletePooling.pdf\", 9, 6)  \ndev.off()\n```  \n\n###No pooling (no overall predictor, with diff intercepts for each participant) using regression: Size and distance \n##### a)  Multiple Regression: Different intercepts for each participant, common slope \n```{r, echo = FALSE}    \n#No constant term (-1) so all participants are included \nSizeDistNoPool.lm<-lm(Emmert_distance_meters~Perceived_dist + factor(Participant) - 1, data = Size_distance)\nprint(SizeDistNoPool.lm)\nsummary(SizeDistNoPool.lm)\n\n```\n\n##### b) Figure 8\n```{r, echo = FALSE, fig.width = 8, fig.height = 8}\nsubs <- unique(Size_distance$Participant)\ncols <- gray(1:length(subs)/length(subs))\n\nplot(Emmert_distance_meters~Perceived_dist, data = Size_distance, pch = 16, \n     col=addalpha(cols[match(Size_distance$Participant, subs)], 0.65),\n     main = \"No Pooling:\\nRegression of Emmert Distance and Perceived Distance\",\n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance\\n(m)\", \n     las = 1) \n#Unique intercept per participant, the same slope\n\npreds <- predict(SizeDistNoPool.lm)\nfor (i in 1:length(subs)){\n    subindex <- which(Size_distance$Participant == subs[i])\n    lines(Size_distance$Perceived_dist[subindex], preds[subindex], col = cols[i])\n}\n\naxis.break(axis = 1, style = \"slash\")\naxis.break(axis = 2, style = \"slash\")\n\ndev.copy(pdf, file=\"plots/Figure_8_no_pool.pdf\", 8, 8)  \ndev.off()\n```\n\n\n###9. Complete pooling of size and distance using rmcorr overall (ignoring factor levels of actual distance) \n##### a) rmcorr results\n```{r, echo=FALSE}\n#Seperate rmcorr on each actual distance (factor level)\nDistance_EmmertDist_Overall.rmc<-rmcorr(participant = Participant, measure1 = Perceived_dist, measure2 = Emmert_distance_meters, dataset = Size_distance)\nDistance_EmmertDist_Overall.rmc\n```\n\n##### b) Figure 9: rmcorr FLOP \n```{r, echo=FALSE, fig.width = 9, fig.height = 6}\npal4<-colorRampPalette(brewer.pal(9,\"Reds\"))\n\npar(cex.lab=1.2, cex.axis=1.2, cex.main=1.2, cex.sub=1.2, mar=c(6,5.5,4,3.5), oma=c(1,1,1,1), mgp = c(4, 1, 0))\nFigure8<-plot(Distance_EmmertDist_Overall.rmc, Size_distance, overall = FALSE,\n              ylab = \"Emmert Distance (m)\",\n              xlab = \"Perceived Distance\\n(m)\", las = 1, palette = pal4,\n              main = (\"Rmcorr Ignoring Factor Levels\"))\naxis.break(axis = 1, style = \"slash\")\naxis.break(axis = 2, style = \"slash\")\n\ndev.copy(pdf, file=\"plots/Figure9_FLOP_rm_overall.pdf\", 9, 6)  \ndev.off()\n\n```\n\n###10. Rmcorr with seprate models: Emmert Distance (size) and distance  \n##### a) Three separate rmcorrs\n```{r, echo=TRUE}\n\n#Subset the data first\nSize_distance_actual2<-subset(Size_distance, Actual_dist_meters==2)\nSize_distance_actual4<-subset(Size_distance, Actual_dist_meters==4)   \nSize_distance_actual6<-subset(Size_distance, Actual_dist_meters==6)\n\n#Seperate rmcorr on each actual distance (factor level)\nDistance_EmmertDist2.rmc<-rmcorr(participant = Participant, measure1 = Perceived_dist, measure2 = Emmert_distance_meters, dataset = Size_distance_actual2)\nDistance_EmmertDist2.rmc\n\nDistance_EmmertDist4.rmc<-rmcorr(participant = Participant, measure1 = Perceived_dist, \n                                 measure2 = Emmert_distance_meters, dataset = Size_distance_actual4)\nDistance_EmmertDist4.rmc\n\nDistance_EmmertDist6.rmc<-rmcorr(participant = Participant, measure1 = Perceived_dist, \n                                 measure2 = Emmert_distance_meters, dataset = Size_distance_actual6)\nDistance_EmmertDist6.rmc\n```\n\n##### b) Figure 10: Emmert Distance (size) and distance rmcorrs \n```{r, echo=FALSE, fig.width = 10, fig.height = 5}\n\npar(mfrow=c(1,3), cex.lab=1.1, cex.axis=1.1, cex.main=1.1, cex.sub = 1.1, mgp=c(3.2,0.8,0))\n#par(mfrow=c(1,3), mar=c(5,5,4,0.75), oma=c(0,2,0,0), mgp=c(3.2,0.80,0), cex.lab=1.2, cex.axis=1.1, cex.main=1.2, cex.sub=1.15)\n\nBlues<-(brewer.pal(9,'Blues'))\npal1<-colorRampPalette(Blues)\n\nOranges<-(brewer.pal(9,'Oranges'))\npal2<-colorRampPalette(Oranges)\n\nGreens<-(brewer.pal(9,'Greens'))\npal3<-colorRampPalette(Greens)\n\nplot(Distance_EmmertDist2.rmc, Size_distance_actual2, overall = FALSE,\n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance\\n(m)\", las = 1, ylim = c(1,3), xlim = c(1,3), palette = pal1,\n     main = (\"a) Actual Distance\\n2m\"), cex = 1.2)\naxis.break(axis = 1, style = \"slash\", brw = 0.0125)\naxis.break(axis = 2, style = \"slash\", brw = 0.0125)\n\nplot(Distance_EmmertDist4.rmc, Size_distance_actual4, overall = FALSE,       \n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance\\n(m)\", las = 1, ylim = c(2,7), xlim = c(2,6), palette = pal2,\n     main = (\"b) Actual Distance\\n4m\"), cex = 1.2)\naxis.break(axis = 1, style = \"slash\", brw = 0.0125)\naxis.break(axis = 2, style = \"slash\", brw = 0.0125)\n\nplot(Distance_EmmertDist6.rmc, Size_distance_actual6, overall = FALSE, \n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance\\n(m)\", las = 1, ylim = c(2,11), xlim = c(3,9), palette = pal3,\n     main = (\"c) Actual Distance\\n6m\"), cex = 1.2)\naxis.break(axis = 1, style = \"slash\", brw = 0.0125)\naxis.break(axis = 2, style = \"slash\", brw = 0.0125)\n\ndev.copy(pdf, file=\"plots/Figure10_size_dist_sep.pdf\", 10, 5)     \ndev.off()  \n\n```\n\n\n###11. Forest plot of separate rmcorrs \n```{r, echo=FALSE, fig.width = 9, fig.height = 6}\n\nyi<-c(Distance_EmmertDist2.rmc$r, Distance_EmmertDist4.rmc$r, Distance_EmmertDist6.rmc$r)\nni<-rep(101, length.out = 3)\neffectlabels<-c(\"Actual Distance 2m\",\"Actual Distance 4m\", \"Actual Distance 6m\")\nDistMeta<-data.frame(cbind(effectlabels, as.numeric(yi), as.numeric(ni)))\n\n#Parametric Confidence Intervals\ndev <-escalc(ri = yi, ni = ni, measure=\"ZCOR\", method =\"REML\", data = DistMeta, append = FALSE)\ndevRE <- rma(yi, vi, data = dev)\nconfint(devRE)\nsummary(devRE)\n\nFigure7<-forest(devRE, slab = effectlabels, mlab = \"Overall (Random Effects Model)\",\n                xlab = expression(\"Repeated Measures Correlation Coefficient\"~\"(\"*italic('r'[rm])*\")\")) \ntext(-0.88, 5, \"Factor Level\", pos = 1, font = 2)\ntext(0.70, 5, expression(italic(r)[rm] ~~ \"[95% CI]\"), pos = 1, font = 2)\n\ndev.copy(pdf, file=\"plots/Figure10_Forest.pdf\", 9, 6)  \ndev.off()\n\n```\n\n###12. Multi-level modeling of size and distance data \n##### Multi-level modeling and model comparison\n```{r, echo=FALSE}\n\n#Knitting the Rmd throws errors with data = ... in lmer, even though it works fine as a script. No clue why????\n#NullModel<-lmer(Emmert_distance_meters ~  1 + (1|Participant), data = Size_distance, REML = FALSE)\n#Note actual_dist_meters has only 3 levels, very spare for random effect. Not specified as an RE here.\n\n#Clunky Rmd safe version\n#Random Int (Participant) only\nNullModel<- lmer(Size_distance$Emmert_distance_meters ~  1 + (1 | Size_distance$Participant), REML = FALSE)\n\n#Model 1: Null + fixed effect actual distance\nModel1 <- lmer(Size_distance$Emmert_distance_meters ~ Size_distance$Actual_dist_meters + \n              (1|Size_distance$Participant), \n              REML = FALSE)\n\n#Model 2: Model 1 + fixed effect perceived distance  \nModel2 <- lmer(Size_distance$Emmert_distance_meters ~ Size_distance$Actual_dist_meters + Size_distance$Perceived_dist + \n              (1|Size_distance$Participant), \n              REML = FALSE)\n\n#Model 3: Model 2 + fixed effect actual distance x  perceived dist (fully crossed)\nModel3 <- lmer(Size_distance$Emmert_distance_meters ~ Size_distance$Actual_dist_meters*Size_distance$Perceived_dist + \n              (1|Size_distance$Participant), \n              REML = FALSE)\n\n#Model X: Doesn't converge\n# ModelX <- lmer(Size_distance$Emmert_distance_meters ~ Size_distance$Actual_dist_meters*Size_distance$Perceived_dist + \n#               (1 + Size_distance$Perceived_dist|Size_distance$Participant), \n#               REML = FALSE)\n\n#Model4: Fully crossed fixed effects, RE slope for perceived dist by participant (does not converge with correlated slope)\nModel4<- lmer(Size_distance$Emmert_distance_meters ~ Size_distance$Actual_dist_meters*Size_distance$Perceived_dist + \n              (-1 + Size_distance$Perceived_dist|Size_distance$Participant) + (1|Size_distance$Participant), \n              REML = FALSE)\n\n#ModelY: Model 4 + RE int by participant (intercept ends up being zero), so it is the same as Model4 \n# ModelY<- lmer(Size_distance$Emmert_distance_meters ~ Size_distance$Actual_dist_meters*Size_distance$Perceived_dist + \n#               (-1 + Size_distance$Perceived_dist|Size_distance$Participant) + (1|Size_distance$Participant), \n#               REML = FALSE)\n\n#ModelZ: Amazing this even converges b/c actual dist has only 3 levels, not enough to be an RE. \n#Fully crossed fixed effects. RE correlated int by participants, RE slopes for perceived dist and actual dist.\n# ModelZ<- lmer(Size_distance$Emmert_distance_meters ~ Size_distance$Actual_dist_meters*Size_distance$Perceived_dist +\n#               (1 + Size_distance$Perceived_dist + Size_distance$Actual_dist_meters|Size_distance$Participant),\n#               REML = FALSE)\n\n#Model Comparison\nanova(NullModel, Model1, Model2, Model3, Model4)\n\nSizeDistModels<-list()\nSizeDistModels[1:5]<-c(NullModel, Model1, Model2, Model3, Model4)\n\nModelTable<-aictab(SizeDistModels, modnames = c(\"Null\", \"Model 1\", \"Model 2\", \"Model 3\", \"Model 4\"))\nModelTable\nevidence(ModelTable)\n\n#Pseudo R2s\nr.squaredGLMM(Model4)\n\n```\n\n##### b) Figure 12 --Graph the best fit model-- Model 4 \n```{r, echo=FALSE, fig.width = 9, fig.height = 6}\nplot(Emmert_distance_meters~Perceived_dist, data = Size_distance, type = \"n\", \n     main = \"Best Fit Multilevel Model\",\n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance\\n(m)\", \n     las = 1) \n\ngetranges<-function(readdata) \n{\n  XYRange<<-range(readdata[\"Perceived_dist\"])\n}\n\n#Get predicted values \nPercDistModel4<-predict(Model4)\nSeqParticipant<- rep(1:20, each = 2, times = 9)\nSizeDistMod4<-cbind(SeqParticipant, Size_distance, PercDistModel4)\nSizeDistBestFit<-SizeDistMod4[order(SeqParticipant, SizeDistMod4$PercDistModel4),]\n\n#Plot OVerall (Level 2) fixed effects w/o discont\nFixedEffectsMod4<-fixef(Model4)\nSlopeFE<-FixedEffectsMod4[2]+FixedEffectsMod4[3]+FixedEffectsMod4[4]\ngetranges(SizeDistBestFit)\nablineclip(FixedEffectsMod4[1], SlopeFE, col = \"black\",  x1 = XYRange[1], \n           x2 = XYRange[2], lwd = 2)\n\n#Plot random effects\nPlotRE<- function(N, length, PredictData, cols) \n{\n  for (i in 1:N) \n  {\n    Extract<-1+(i-1)*length  #Starts at 1, then goes to 7, 13, ..., 115 \n    lines(spline(PredictData[Extract:(length*i), 6],PredictData[Extract:(length*i), 11]), col = cols[i])\n  }\n}\n\n#Plot Overall fixed effects w/discont\n#Actual distance has a mean = 4, sd = 2 \nPreds <- list()\nInts <- list()\nSlopes <- list()\n\npals <- c('Blues', 'Oranges', 'Greens')\nsubs <- unique(Size_distance$Participant)\nfor (i in 1:3){\n  \n  tempDat <- Size_distance[Size_distance$Actual_dist_meters == i*2, ]\n  cols <- addalpha(colorRampPalette(brewer.pal(9, pals[i]))(length(subs)), .6)\n  points(Emmert_distance_meters~Perceived_dist, data = tempDat, pch = 16, \n         col=cols[match(tempDat$Participant, subs)])\n  \n  Preds[[i]] <- subset(SizeDistBestFit,Actual_dist_meters == i*2)\n  Ints[[i]] <- FixedEffectsMod4[1]+FixedEffectsMod4[2]*(i*2)\n  Slopes[[i]] <- FixedEffectsMod4[3]+FixedEffectsMod4[4]*(2 * (i - 2))\n  \n  getranges(Preds[[i]])\n  ablineclip(Ints[[i]], Slopes[[i]], col = \"gray40\", lty = 2, x1 = XYRange[1]-.2, \n             x2 = XYRange[2]+.2, lwd = 2)\n  \n  PlotRE(length(subs), 6, Preds[[i]], cols)\n  \n}\n\ndev.copy(pdf, file=\"plots/Figure12_multilevel_model.pdf\", 9, 6)  \ndev.off()\n```\n\n## Standard Correlation Power Curve (not in paper)\n```{r, echo=FALSE}\nrs <- c(0.1, 0.3, 0.5)\nnvals <- seq(8, 1000, length.out=1000)\n\ngreenscols<-brewer.pal(9, \"Greens\")\ngreenscols3<-c(greenscols[3],greenscols[6],greenscols[9])\n\nplot(nvals, seq(0,1, length.out=length(nvals)), xlab=\"Sample Size\", ylab=\"Power\",\n     main=\"Power Curve for Standard Correlation\", type=\"n\")\nfor (i in 1:3) \n{\n  powvals <<- sapply(nvals, function (x) pwr.r.test(n=x, r=rs[i])$power)\n  lines(nvals, powvals, lwd=2.5, col=greenscols3[i])\n}\nlegend(\"bottomright\", lwd=2, col=greenscols3, legend=c(\"0.1\", \"0.3\", \"0.5\"))\nabline(a = 0.8, b=0, col=1, lty=2, lwd= 2.5)\n```\n\n\n##Appendix B. Separate models by factor level w/simple regression/correlation\n##### a)  Multiple Regression: Different intercepts for each participant, common slope \n```{r, echo = FALSE}    \n#Separate models for each actual dist, quasi-piecewise/segmented regression  \nBreak2<-subset(Size_distance, Actual_dist_meters == 2)\nBreak4<-subset(Size_distance, Actual_dist_meters == 4)\nBreak6<-subset(Size_distance, Actual_dist_meters == 6)\n\nSizeDistNoPoolBreak2.lm<-lm(Emmert_distance_meters~ Perceived_dist, data = Break2)\nprint(SizeDistNoPoolBreak2.lm)s\nsummary(SizeDistNoPoolBreak2.lm)\ncor.test(Break2$Perceived_dist, Break2$Emmert_distance_meters)\n\nSizeDistNoPoolBreak4.lm<-lm(Emmert_distance_meters~ Perceived_dist, data = Break4)\nprint(SizeDistNoPoolBreak4.lm)\nsummary(SizeDistNoPoolBreak4.lm)\ncor.test(Break4$Perceived_dist, Break4$Emmert_distance_meters)\n\nSizeDistNoPoolBreak6.lm<-lm(Emmert_distance_meters~ Perceived_dist, data = Break6)\nprint(SizeDistNoPoolBreak6.lm)\nsummary(SizeDistNoPoolBreak6.lm)\ncor.test(Break6$Perceived_dist, Break6$Emmert_distance_meters)\n\n\nplot(Emmert_distance_meters~Perceived_dist, data = Size_distance, pch = 16,\n     col=rgb(red = 0.0, green = 0.0, blue = 0.0, alpha = 0.3),\n     main = \"Separate Regressions of Actual Distance:\\n Emmert Distance and Perceived Distance\",\n     ylab = \"Emmert Distance (m)\",\n     xlab = \"Perceived Distance\\n(m)\",\n     las = 1)\ncurve(1.5336 + 0.2851*x, add = TRUE, from = min(Break2$Perceived_dist), to = max(Break2$Perceived_dist))\ncurve(3.0811 + 0.3387*x, add = TRUE, from = min(Break4$Perceived_dist), to = max(Break4$Perceived_dist))\ncurve(5.6731 + 0.1786*x, add = TRUE, from = min(Break6$Perceived_dist), to = max(Break6$Perceived_dist))\n\ndev.copy(pdf, file=\"plots/AppendixB_Figure.pdf\", 8, 8) \ndev.off()\n```",
    "created" : 1467298734473.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1676146028",
    "id" : "6218196B",
    "lastKnownWriteTime" : 1467299138,
    "last_content_update" : 1467299138905,
    "path" : "C:/Users/Laura Cooper/Desktop/Need from Laptop/rmcorr package/rmcorr/Rmd/06.30.2016_extra.rmd",
    "project_path" : "Rmd/06.30.2016_extra.rmd",
    "properties" : {
        "tempName" : "Untitled2"
    },
    "relative_order" : 9,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}